<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitcamp.java77.dao.CosmeticDao">
	<insert id="insertMember" parameterType="CosmeticMember">
		insert into member(ID, PWD, NAME, EMAIL, GENDER, BIRTH, POSNO, ADDR_DEF, TEL, REC_EMAIL)
		values(#{id}, #{pwd}, #{name}, #{email}, #{gender}, #{birth}, #{posNo}, #{addrDef}, #{tel}, #{recEmail})
		<selectKey keyProperty="memberNo" order="AFTER" resultType="int">
			select max(mno) from member
		</selectKey>
	</insert>
	
	<select id="searchID" parameterType="string" resultType="int">
		select count(*)
		  from member
		 where id = #{id}
	</select>
	
 	<insert id="insertReview" useGeneratedKeys="true" parameterType="CosmeticReview" keyProperty="reviewNo">
 		insert into review(mno,title,cont,vcnt,spart,stat,reg_date)
 		values(#{memberNo},#{title},#{content},0,#{sugeryPart},#{status},now())
 		<selectKey keyProperty="reviewNo" order="AFTER" resultType="int">
 			select max(rno) from review
 		</selectKey>
 	</insert>
 	
 	<insert id="insertReviewPhoto" parameterType="CosmeticReviewPhoto">
 		insert into review_phot(rno,fil_path)
 		values(#{reviewNo},#{filePath})
 	</insert>
 	
 	<select id="selectReviewList" parameterType="CosmeticSearch" resultMap="reviewResultMap">
 		select a.rno as reviewNo, mno as memberNo, a.hno as hospitalNo, a.title as title, a.cont as content, a.vcnt as viewCnt, a.spart as sugeryPart, a.stat as status,b.fil_path as filePath, a.reg_date as regDate
		from review a inner join review_phot b
		on a.rno = b.rno
		order by a.reg_date desc
		limit #{start},#{end}
 	</select>
 	
 	<resultMap id="reviewResultMap" type="CosmeticReview">
 		<result property="reviewNo" column="reviewNo" />
 		<result property="memberNo" column="memberNo" />
 		<result property="hospitalNo" column="hospitalNo" />
 		<result property="title" column="title"/>
 		<result property="title" column="title" />
 		<result property="content" column="content" />
 		<result property="viewCnt" column="viewCnt" />
 		<result property="sugeryPart" column="sugeryPart" />
 		<result property="status" column="status" />
 		<result property="regDate" column="regDate" />
 		<collection property="reviewPhoto" column="filePath"  resultMap="reviewPhotoMap" ofType="cosmeticReviewPhoto" javaType="ArrayList"></collection>
 	</resultMap>
 	
 	<resultMap id="reviewPhotoMap" type="CosmeticReviewPhoto">
 		<result property="filePath" column="filePath" />
 	</resultMap>
 	
 	<select id="selectReviewListDetail" parameterType="int" resultType="CosmeticReview">
 		select RNO as reviewNo, MNO as memberNo, HNO as hospitalNo,title as title,CONT as content, VCNT as viewCnt, SPART as sugeryPart, STAT as status, REG_DATE as regDate 
 		from review where rno = #{reviewNo}
 	</select>
 	
 	<select id="selectReviewComment" parameterType="int" resultMap="reviewCommentMap">
 		select a.CMNO as commentNo, b.id as id, a.RNO as reviewNo,a.MNO as memberNo, a.CONT as content,a.REG_DATE as regDate
		from comment a
		inner join member b
		on a.mno = b.mno
		where rno = #{reviewNo}
 	</select>
 	
 	<resultMap id="reviewCommentMap" type="CosmeticReviewComment">
 		<result property="commentNo" column="commentNo" />
 		<result property="reviewNo" column="reviewNo" />
 		<result property="memberNo" column="memberNo"/>
 		<result property="content" column="content" />
 		<result property="regDate" column="regDate"/>
 		<collection property="member" column="id" resultMap="memberMap" ofType="CosmeticMember" javaType="ArrayList"></collection>
 	</resultMap>
 	
 	<resultMap id="memberMap" type="CosmeticMember">
 		<result property="id" column="id" />
 	</resultMap>
 	
 	<select id="selectReviewPhoto" parameterType="int" resultType="CosmeticReviewPhoto">
		select RPNO as photoNo, RNO as reviewNo, FIL_PATH as filePath 
		from review_phot where rno = #{reviewNo}
 	</select>
 	
 	<select id="selectLogin" parameterType="CosmeticMember" resultType="int">
 		select count(*)
 		from member
 		where id = #{id}
 		and pwd = #{pwd}
 	</select>
 	
 	<select id="selectMember" parameterType="int" resultType="CosmeticMember">
 		select mno as memberNo,id,pwd,name,email,gender,birth,posno,addr_def as addrDef, addr_det as addrDet, tel, cPart, rec_email as recEmail, cont as content, reg_date as regDate 
 		from member
		where mno = #{no}
 	</select>
</mapper>