<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitcamp.java77.dao.CosmeticDao">

	<!-- INSERT 영역 -->
	<insert id="insertMember" parameterType="CosmeticMember">
		insert into member(ID, PWD, NAME, EMAIL, GENDER, BIRTH, POSNO, ADDR_DEF, TEL, REC_EMAIL)
		values(#{id}, #{pwd}, #{name}, #{email}, #{gender}, #{birth}, #{posNo}, #{addrDef}, #{tel}, #{recEmail})
		<selectKey keyProperty="memberNo" order="AFTER" resultType="int">
			select max(mno) from member
		</selectKey>
	</insert>
	
	<select id="searchID" parameterType="string" resultType="int">
		select count(*)
		  from member
		 where id = #{id}
	</select>
	
 	<insert id="insertReview" useGeneratedKeys="true" parameterType="CosmeticReview" keyProperty="reviewNo">
 		<choose>
 			<when test="status == 0">
 				insert into review(mno,title,cont,vcnt,spart,stat,reg_date)
 				values(#{memberNo},#{title},#{content},0,#{sugeryPart},#{status},now())
 			</when>
 			<otherwise>
 				insert into review(mno,title,cont,vcnt,spart,stat,hos_name,doc_name,sway,sprice,sdate,reg_date)
 				values(#{memberNo},#{title},#{content},0,#{sugeryPart},#{status},#{hospitalName},#{doctorName},#{sugeryWay},#{sugeryPrice},#{sugeryDate},now())
 			</otherwise>
 		</choose>
 		<selectKey keyProperty="reviewNo" order="AFTER" resultType="int">
 			select max(rno) from review
 		</selectKey>
 	</insert>
 	
 	<insert id="insertReviewPhoto" parameterType="CosmeticReviewPhoto">
 		insert into review_phot(rno,fil_path)
 		values(#{reviewNo},#{filePath})
 	</insert>
 	
 	<insert id="insertReviewComment" parameterType="cosmeticReviewComment">
 		insert into comment(rno,mno,cont,reg_date)
 		values(#{reviewNo},#{memberNo},#{content},now())
 		<selectKey keyProperty="commentNo" order="AFTER" resultType="int">
 			select max(cmno) from comment
 		</selectKey>
 	</insert>
 	
 	<!-- SELECT 영역 -->
<<<<<<< HEAD
=======
 	
 	<!-- 병원 정보 resultMap -->
 	<resultMap id="hospitalInfoListMap" type="CosmeticHospital">
 		<result property="hospitalNo" column="HNO" />
 		<result property="name" column="NAME" />
 		<result property="surgeryPart" column="SPART" />
 		<result property="content" column="CONT"/>
 		<result property="addr" column="ADDR" />
 		<result property="tel" column="TEL" />
 		<result property="link" column="LINK" />
 		<result property="regDate" column="REG_DATE" />
 	</resultMap>
 	<!-- 병원 정보 select -->
 	<select id="selectHospital" resultMap="hospitalInfoListMap">
 		select HNO, NAME, SPART, CONT, ADDR, TEL, LINK, REG_DATE
 		  from HOSPITAL
 	</select>
 	
>>>>>>> Chorong-Development
 	<select id="selectReviewList" parameterType="CosmeticSearch" resultMap="reviewResultMap">
 		select a.rno as reviewNo, mno as memberNo, a.hno as hospitalNo, a.title as title, a.cont as content, a.vcnt as viewCnt, a.spart as sugeryPart, a.stat as status,b.fil_path as filePath, a.reg_date as regDate
		from review a inner join review_phot b
		on a.rno = b.rno
		order by a.reg_date desc
		limit #{start},#{end}
 	</select>
 	
 	<resultMap id="reviewResultMap" type="CosmeticReview">
 		<result property="reviewNo" column="reviewNo" />
 		<result property="memberNo" column="memberNo" />
 		<result property="hospitalNo" column="hospitalNo" />
 		<result property="title" column="title"/>
 		<result property="title" column="title" />
 		<result property="content" column="content" />
 		<result property="viewCnt" column="viewCnt" />
 		<result property="sugeryPart" column="sugeryPart" />
 		<result property="status" column="status" />
 		<result property="regDate" column="regDate" />
 		<collection property="reviewPhoto" column="filePath"  resultMap="reviewPhotoMap" ofType="cosmeticReviewPhoto" javaType="ArrayList"></collection>
 	</resultMap>
 	
 	<resultMap id="reviewPhotoMap" type="CosmeticReviewPhoto">
 		<result property="filePath" column="filePath" />
 	</resultMap>
 	
 	
 	<select id="selectReviewListDetail" parameterType="int" resultType="CosmeticReview">
 		select RNO as reviewNo, MNO as memberNo, HNO as hospitalNo,title as title,CONT as content, VCNT as viewCnt, SPART as sugeryPart, STAT as status,hos_name as hospitalName,doc_name as doctorName,sway as sugeryWay, sprice as sugeryPrice, sdate as sugeryDate, REG_DATE as regDate 
 		from review where rno = #{reviewNo}
 	</select>
 	
 	<select id="selectReviewComment" parameterType="int" resultMap="reviewCommentMap">
 		select a.CMNO as commentNo, b.id as id, a.RNO as reviewNo,a.MNO as memberNo, a.CONT as content,a.REG_DATE as regDate
		from comment a
		inner join member b
		on a.mno = b.mno
		where rno = #{reviewNo}
 	</select>
 	
 	<resultMap id="reviewCommentMap" type="CosmeticReviewComment">
 		<result property="commentNo" column="commentNo" />
 		<result property="reviewNo" column="reviewNo" />
 		<result property="memberNo" column="memberNo"/>
 		<result property="content" column="content" />
 		<result property="regDate" column="regDate"/>
 		<collection property="member" column="id" resultMap="memberMap" ofType="CosmeticMember" javaType="ArrayList"></collection>
 	</resultMap>
 	
 	<resultMap id="memberMap" type="CosmeticMember">
 		<result property="id" column="id" />
 	</resultMap>
 	
 	<select id="selectReviewPhoto" parameterType="int" resultType="CosmeticReviewPhoto">
		select RPNO as photoNo, RNO as reviewNo, FIL_PATH as filePath 
		from review_phot where rno = #{reviewNo}
 	</select>
 	
 	<select id="selectLogin" parameterType="CosmeticMember" resultType="int">
 		select count(*)
 		from member
 		where id = #{id}
 		and pwd = #{pwd}
 	</select>
 	
 	<select id="selectMember" parameterType="cosmeticMember" resultType="CosmeticMember">
<<<<<<< HEAD
 		select mno as memberNo,id,pwd,name,email,gender,birth,posno,addr_def as addrDef, addr_det as addrDet, tel, cPart, rec_email as recEmail, cont, reg_date as regDate 
=======
 		select mno as memberNo,id,pwd,name,email,gender,birth,posno,addr_def as addrDef, addr_det as addrDet, tel, cPart, rec_email as recEmail, cont as content, reg_date as regDate 
>>>>>>> Chorong-Development
 		from member
		where id = #{id}
		and pwd = #{pwd}
 	</select>
 	
 	<select id="selectReviewMatch" parameterType="cosmeticReview" resultType="int">
 		select count(*)
 		from review
 		where rno = #{reviewNo}
 		and mno = #{memberNo}
 	</select>
 	
 	<select id="selectReviewPhotoNo" parameterType="int" resultType="cosmeticReviewPhoto">
 		select rpno as photoNo
 		from review_phot
 		where rno = #{reviewNo}
 	</select>
 	
 	<!-- DELETE 영역 -->
 	<delete id="deleteReviewPhoto" parameterType="int">
 		delete from review_phot
 		where rno = #{reviewNo}
 	</delete>
 	
 	<delete id="deleteReview" parameterType="cosmeticReview">
 		delete from review
 		where rno = #{reviewNo}
 		and mno = #{memberNo}
 	</delete>
 	
 	
 	<!-- UPDATE 영역 -->
 	<update id="updateReview" parameterType="cosmeticReview">
 	<choose>
 		<when test="status == 0">
	 		update review
	 		set title = #{title}
	 		,cont = #{content}
	 		,spart = #{sugeryPart}
	 		,stat = #{status}
	 		where rno=#{reviewNo}
	 		and mno=#{memberNo}
 		</when>
 		<otherwise>
			update review
	 		set title = #{title}
	 		,cont = #{content}
	 		,spart = #{sugeryPart}
	 		,stat = #{status}
	 		,hos_name = #{hospitalName}
	 		,doc_name = #{doctorName}
	 		,sway = #{sugeryWay}
	 		,sprice = #{sugeryPrice}
	 		,sdate = #{sugeryDate}
	 		where rno=#{reviewNo}
	 		and mno=#{memberNo}
 		</otherwise>
 	</choose>
 	</update>
 	
 	<update id="updateReviewPhoto" parameterType="cosmeticReviewPhoto">
 		update review_phot
 		set fil_path = #{filePath}
 		where rno = #{reviewNo}
 		and rpno = #{photoNo}
 	</update>
 	
 	
</mapper>